---
status: pending
priority: p1
issue_id: DATA-005
tags: [code-review, database, migration, data-integrity]
dependencies: []
---

# CRITICAL: Duplicate Column Additions in Migration 0013

## Problem Statement

Migration file `drizzle/0013_brave_amphibian.sql` attempts to add columns `business_line_id` and `deleted_at` to the `users` table, but these columns already exist in the schema. This will cause migration failure in production deployment.

**Impact**: Deployment blocker, database migration will fail, rollback required
**Likelihood**: 100% (will fail on first deploy attempt)

## Findings

**Data Migration Expert Report:**

- Lines 22-23 of migration 0013 duplicate existing columns
- Schema already defines these columns (lines 14-15 of schema.ts)
- Migration was auto-generated by Drizzle but includes erroneous additions
- Will throw `SQLITE_ERROR: duplicate column name` on execution

**Evidence:**

```sql
-- drizzle/0013_brave_amphibian.sql (lines 22-23)
ALTER TABLE `users` ADD `business_line_id` text REFERENCES business_lines(id);
ALTER TABLE `users` ADD `deleted_at` integer;
-- ❌ DUPLICATE: These columns already exist
```

```typescript
// lib/db/schema.ts (lines 14-15)
export const users = sqliteTable('users', {
  // ... other fields
  businessLineId: text('business_line_id').references(() => businessLines.id), // ✅ Already exists
  deletedAt: integer('deleted_at', { mode: 'timestamp' }), // ✅ Already exists
});
```

**Current Database State:**

- 4 existing bids in production
- Users table already has business_line_id and deleted_at columns
- Migration 0013 will fail when applied

## Proposed Solutions

### Solution 1: Delete Duplicate Lines from Migration (Recommended)

**Pros:**

- Simplest fix
- No data loss risk
- Preserves migration history
- Safe for existing data

**Cons:**

- Manual file edit required
- Need to verify no other references

**Effort**: Small (15 minutes)
**Risk**: Very Low

**Implementation:**

1. Open `drizzle/0013_brave_amphibian.sql`
2. Delete lines 22-23
3. Test migration on dev database
4. Commit fix

### Solution 2: Regenerate Migration from Scratch

**Pros:**

- Clean slate
- Ensures perfect schema alignment

**Cons:**

- Loses migration history
- More complex process
- Requires re-testing

**Effort**: Medium (1 hour)
**Risk**: Medium (might miss other issues)

### Solution 3: Create Compensating Migration

**Pros:**

- Preserves failed migration in history
- Explicit fix trail

**Cons:**

- Adds unnecessary migration file
- Doesn't fix root cause
- Confusing for future developers

**Effort**: Small (30 minutes)
**Risk**: Low

## Recommended Action

**Use Solution 1: Delete Duplicate Lines**

This is the cleanest fix with zero risk. The migration should only add the `deep_migration_analyses` table, not modify existing tables.

## Technical Details

**Affected Files:**

- `drizzle/0013_brave_amphibian.sql` - Delete lines 22-23

**Corrected Migration:**

```sql
-- drizzle/0013_brave_amphibian.sql (corrected)
CREATE TABLE `deep_migration_analyses` (
  `id` text PRIMARY KEY NOT NULL,
  `bid_opportunity_id` text NOT NULL,
  `job_id` text NOT NULL,
  `status` text NOT NULL,
  `started_at` integer,
  `completed_at` integer,
  `error_message` text,
  `source_cms` text,
  `target_cms` text,
  `website_url` text NOT NULL,
  `content_architecture` text,
  `migration_complexity` text,
  `accessibility_audit` text,
  `pt_estimation` text,
  `version` integer DEFAULT 1 NOT NULL,
  `created_at` integer,
  `updated_at` integer,
  FOREIGN KEY (`bid_opportunity_id`) REFERENCES `bid_opportunities`(`id`) ON UPDATE no action ON DELETE no action
);
-- ✅ NO duplicate user table modifications
```

**Database Changes:** None (fix prevents erroneous changes)

**Breaking Changes:** None

## Acceptance Criteria

- [ ] Lines 22-23 deleted from migration 0013
- [ ] Migration 0013 runs successfully on fresh database
- [ ] Migration 0013 runs successfully on existing dev database
- [ ] No duplicate column errors in logs
- [ ] Schema introspection shows no differences after migration
- [ ] All 4 existing bids still accessible after migration

## Work Log

**2026-01-17**: Issue identified by data-migration-expert agent during Epic 7 Phase 1 review

## Resources

- [Drizzle Kit Migration Docs](https://orm.drizzle.team/kit-docs/overview)
- Migration file: `drizzle/0013_brave_amphibian.sql`
- Schema definition: `lib/db/schema.ts:14-15`
