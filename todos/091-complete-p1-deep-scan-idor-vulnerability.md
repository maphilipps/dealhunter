---
status: complete
priority: p1
issue_id: '091'
tags: [code-review, security, deep-scan-v2, idor]
dependencies: []
---

# Missing Resource-Level Authorization (IDOR Vulnerability)

## Problem Statement

The Deep Scan v2 tools (STATUS, RESULT, CANCEL, ACTIVITY) do not verify that the authenticated user owns or has permission to access the requested `runId`. Any authenticated user with minimum role can access, view, or cancel another user's deep scan runs.

## Findings

**Agent:** security-sentinel

**File:** `lib/agent-tools/tools/deep-scan.ts`
**Lines:** 126-169 (STATUS), 180-294 (RESULT), 305-352 (CANCEL), 468-507 (ACTIVITY)

```typescript
// Current - NO ownership check:
const run = await db.query.deepScanV2Runs.findFirst({
  where: eq(deepScanV2Runs.id, input.runId), // Only checks runId, not ownership
});
```

**Impact:**

- Unauthorized access to sensitive scan results belonging to other users
- Ability to cancel another user's running scans (denial of service)
- Information disclosure of business-critical analysis data

**Exploitability:** High - Any authenticated user can enumerate and access all runs.

## Proposed Solutions

### Option A: Add ownership verification to each tool (Recommended)

**Pros:** Direct fix, clear intent
**Cons:** Code duplication across tools
**Effort:** Small
**Risk:** Low

```typescript
const run = await db.query.deepScanV2Runs.findFirst({
  where: and(
    eq(deepScanV2Runs.id, input.runId),
    context.userRole === 'admin' ? undefined : eq(deepScanV2Runs.userId, context.userId)
  ),
});
```

### Option B: Create shared helper function

**Pros:** DRY, reusable
**Cons:** Additional abstraction
**Effort:** Small
**Risk:** Low

```typescript
async function getRunWithOwnershipCheck(runId: string, context: ToolContext) {
  const isAdmin = context.userRole === 'admin';
  return db.query.deepScanV2Runs.findFirst({
    where: and(
      eq(deepScanV2Runs.id, runId),
      isAdmin ? undefined : eq(deepScanV2Runs.userId, context.userId)
    ),
  });
}
```

## Recommended Action

Implement Option B - create a shared helper function and use it in all 6 affected tools (STATUS, RESULT, CANCEL, DELETE, RETRY, ACTIVITY).

## Technical Details

**Affected Files:**

- `lib/agent-tools/tools/deep-scan.ts`

**Affected Tools:**

- `scan.deepscan.status`
- `scan.deepscan.result`
- `scan.deepscan.cancel`
- `scan.deepscan.delete`
- `scan.deepscan.retry`
- `scan.deepscan.activity`

## Acceptance Criteria

- [ ] All tools verify ownership before returning data
- [ ] Admin users can access any run
- [ ] Non-admin users can only access their own runs
- [ ] Proper 404 error returned for non-existent or unauthorized runs
- [ ] Unit tests cover authorization scenarios

## Work Log

| Date       | Action  | Notes                         |
| ---------- | ------- | ----------------------------- |
| 2026-02-04 | Created | From security-sentinel review |

## Resources

- PR: feat/deep-scan-v2-agent-native
- OWASP IDOR: https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References
